---
description: "Bugfix protocol: reproduce, test, fix, guard."
category: "methodology"
subcategory: "bugfix-protocol"
required: true
globs:
  - "src/**"
  - "app/**"
  - "tests/**"
---

[SOURCE OF TRUTH]
- Editable source: `rules/45-bugfix-protocol.mdc`
- Generated/consumed copy: `.cursor/rules/45-bugfix-protocol.mdc` (keep references intact)

[INTENT]
- Define the mandatory bugfix protocol: reproduce, confirm failing test, fix, guard.

[APPLICABILITY]
- Applies to all bugfixes in non-Tier-S code; requirements are binding unless an explicit risk override per `.cursor/rules/3G-risk-overrides.mdc` is provided.

[CROSS-REFERENCES]
- Architecture/DDD: `.cursor/rules/36-architecture.mdc`, `.cursor/rules/44-ddd.mdc` (binding)
- Testing/change-discipline: `.cursor/rules/31-testing.mdc`, `.cursor/rules/23-change-control.mdc` (binding)
- Risk overrides: `.cursor/rules/3G-risk-overrides.mdc` (explicit overrides only)

[CONCEPTS]
- Bug:
  - A bug is any deviation between actual behavior and the behavior defined by specs, tests, or domain rules, including incorrect results, crashes, missing validations, or security/observability breaches.
  - In this Codex, tests, specs, and domain language (see `.cursor/rules/40-atdd.mdc`, `.cursor/rules/41-bdd.mdc`, `.cursor/rules/44-ddd.mdc`) together define expected behavior.
- Regression:
  - A regression is a bug where behavior that previously worked (as evidenced by tests, specs, or production signals) becomes incorrect after a change.
  - Regression tests are tests that would have failed before the bugfix and pass after, preventing the bug from silently reappearing.
- Green baseline:
  - A green baseline is a state where all relevant tests (unit, integration, acceptance, contract) that are expected to pass for the current branch actually pass.
  - Before applying a bugfix, agents MUST reason from or establish a green baseline (logically or via tooling) so that the impact of the fix on the test suite is clear, per `.cursor/rules/31-testing.mdc` and `.cursor/rules/34-ci.mdc`.


[BUGFIX FLOW]
- Mandatory 4-step protocol:
  1) Reproduce:
     - For any bugfix, the agent MUST derive or locate at least one failing test that captures the bug:
       - Preferably by adding or updating an automated test in the appropriate suite (unit, integration, acceptance) as per `.cursor/rules/31-testing.mdc`.
       - If tests cannot be executed in the current environment, the agent MUST still specify the test (file, name, assertions) and reason concretely about why it would fail against the current implementation.
     - The failing scenario SHOULD be described using domain language and Given/When/Then framing where appropriate, aligned with `.cursor/rules/40-atdd.mdc` and `.cursor/rules/41-bdd.mdc`.
  2) Confirm:
     - The agent MUST ensure that the new or updated test fails against the old implementation, either by:
       - Actually running the tests (where possible), or
       - Providing a clear logical argument (step-by-step) showing which assertion fails and why, given the existing code.
     - A "bugfix" that does not cause any test to fail against the old code MUST be treated as suspicious and requires explicit justification.
  3) Fix:
     - The agent MUST then modify the implementation as minimally as possible to make the new test pass, respecting architecture and layering rules in `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc` (no business logic in controllers, no framework in Domain/Application).
     - The fix MUST target the actual root cause rather than masking the symptom (e.g., not simply loosening assertions or swallowing errors).
  4) Guard:
     - After applying the fix, the agent MUST ensure that:
       - The new regression test now passes, and
       - Existing relevant tests remain green (logically or via tooling), and
       - No unrelated behavior or contracts are changed outside the intended scope, consistent with `.cursor/rules/23-change-control.mdc` and `rules/47-diff-discipline.mdc`.
- This flow is mandatory for all non-trivial bugfixes and is the default expectation for LLM agents and human contributors alike.


[BASE RULES]
- Test-first (or test-with) bugfixing:
  - Every bugfix MUST introduce or strengthen at least one automated test that would have caught the bug when it was introduced, in line with `.cursor/rules/42-tdd.mdc` and `.cursor/rules/31-testing.mdc`.
  - It is NOT acceptable to commit a bugfix that is only manually validated without any regression test, unless explicitly risk-accepted and documented per `.cursor/rules/23-change-control.mdc`.
- Test integrity:
  - Bugfixes MUST NOT weaken or delete tests simply to "make the suite pass":
    - Removing assertions, broadening matches, or deleting tests is equivalent to changing behavior contracts and MUST be treated under `.cursor/rules/46-regression-discipline.mdc` and `.cursor/rules/23-change-control.mdc`.
  - If a test is incorrect because the spec has changed, the spec and test MUST be updated together, and the change MUST be documented (e.g., via ADR or spec update) in line with `.cursor/rules/48-doc-sync.mdc`.
- Scope and classification:
  - Bugfix diffs MUST be scoped as narrowly as possible:
    - Edits MUST focus on the failing code paths, necessary wiring, and associated tests, following `rules/47-diff-discipline.mdc`.
    - Drive-by refactors or unrelated cleanups MUST NOT be bundled into a bugfix unless explicitly requested and justified.
  - Each bugfix MUST classify its nature:
    - Pure bugfix (no contract change): behavior is corrected to match existing tests/specs.
    - Bugfix + contract clarification: behavior is clarified or tightened, effectively changing the contract and requiring change-control and doc/spec sync via `.cursor/rules/23-change-control.mdc` and `.cursor/rules/48-doc-sync.mdc`.


[AGENT BEHAVIOR]
- When asked to fix a bug, agents MUST:
  - First restate the bug as a concrete scenario and propose at least one regression test:
    - Name of the test (descriptive, behavior-focused),
    - Intended file or suite (aligned with `.cursor/rules/31-testing.mdc` structure),
    - Assertions that differentiate correct vs incorrect behavior.
  - Explain how the proposed test:
    - Fails against the current implementation, and
    - Would pass after the intended fix.
  - Only after this MUST the agent propose changes to the implementation.
- Refusals and exceptions:
  - Agents MUST refuse to "fix" a bug without a regression test unless:
    - The user explicitly accepts a temporary exception, and
    - The agent explicitly acknowledges this rule and documents the missing test as a follow-up item (e.g., in an ADR, ticket, or TODO) with clear risk.
  - Agents MUST NOT silently remove or weaken tests to hide failures; any such proposal MUST be treated as a contract change and MUST go through `.cursor/rules/46-regression-discipline.mdc`, `.cursor/rules/23-change-control.mdc`, and `.cursor/rules/48-doc-sync.mdc`.
- Architecture and safety:
  - Agents MUST ensure that bugfixes preserve Clean Architecture and DDD boundaries (`.cursor/rules/36-architecture.mdc`, `.cursor/rules/44-ddd.mdc`) and do not introduce anti-patterns cataloged in `.cursor/rules/3A-anti-patterns.mdc`.
  - For bugs in Tier H/M contexts or bugs affecting security/observability, agents MUST also consult `.cursor/rules/30-security.mdc`, `.cursor/rules/32-observability.mdc`, and `.cursor/rules/3D-operations.mdc` and treat the fix as a higher-risk change.


[VERIFICATION / CHECKS]
- For `@code-reviewer`:
  - MUST verify that each bugfix:
    - Introduces or updates at least one regression test that fails before and passes after the fix, or has an explicitly documented and approved exception.
    - Keeps test integrity: no unexplained test deletions or weakening.
    - Has a diff scope aligned with the stated bug and follows `rules/47-diff-discipline.mdc`.
  - MUST treat bugfix PRs without tests as non-compliant by default, unless there is a documented and approved reason consistent with `.cursor/rules/23-change-control.mdc`.
- For `@architect`:
  - SHOULD review bugfixes that cross bounded contexts, affect Tier H/M services, or change domain invariants to ensure they respect `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`.
  - MUST ensure that bugfixes that also clarify or change contracts trigger appropriate lifecycle, doc-sync, and change-control workflows (`.cursor/rules/35-api-lifecycle.mdc`, `.cursor/rules/48-doc-sync.mdc`, `.cursor/rules/23-change-control.mdc`).
- For `@supervisor` / policy checks:
  - SHOULD enforce policies that flag bugfix changes without associated test modifications and require explicit justification and approval.

