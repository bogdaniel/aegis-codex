---
description: "Threat modeling & trust boundaries: lightweight process, STRIDE categories, trust tier mapping."
required: true
category: "topic"
subcategory: "security"
globs:
  - "src/**"
  - "app/**"
  - "backend/**"
  - "services/**"
  - "docs/**"
---

[SOURCE OF TRUTH]
- Editable source: `rules/30-threat-modeling.mdc`
- Generated/consumed copy: `.cursor/rules/30-threat-modeling.mdc` (keep references intact)

[INTENT]
- Define threat modeling process (STRIDE, trust tiers) and trust boundary mapping.

[APPLICABILITY]
- Applies to security-sensitive/Tier M/H contexts and external integrations; threat modeling requirements are binding unless an explicit risk override per `.cursor/rules/3G-risk-overrides.mdc` is provided.

[THREAT MODELING & TRUST BOUNDARIES BASELINE]

### [LIGHTWEIGHT THREAT MODELING PROCESS]

#### Per-Bounded-Context Threat Modeling
- **MANDATORY:** Tier H/M contexts MUST have threat models:
  - **MUST:** Identify assets, entry points, trust boundaries, and threats.
  - **MUST:** Document threat model (markdown file in `docs/threat-models/` or context directory).
  - **MUST:** Update threat model when new external integrations or sensitive flows are added.
- **MANDATORY:** Threat modeling MUST be:
  - **Lightweight:** Focus on high-risk areas (not exhaustive).
  - **Repeatable:** Use consistent process and templates.
  - **Actionable:** Identify mitigations and assign owners.
- **Verification:** Check that Tier H/M contexts have threat models; threat models are updated when changes occur.

#### STRIDE Categories
- **MANDATORY:** Threat modeling MUST use STRIDE categories:
  - **Spoofing:** Impersonation attacks (fake identities, session hijacking).
  - **Tampering:** Data modification attacks (unauthorized changes, injection).
  - **Repudiation:** Denial of actions (missing audit logs, weak authentication).
  - **Information Disclosure:** Data exposure (leaked secrets, PII exposure).
  - **Denial of Service:** Availability attacks (resource exhaustion, rate limiting bypass).
  - **Elevation of Privilege:** Authorization bypass (privilege escalation, IDOR).
- **MANDATORY:** For each threat category, identify:
  - **Assets:** What is being protected (data, services, credentials).
  - **Entry points:** Where threats can enter (APIs, user input, external services).
  - **Trust boundaries:** Where trust changes (network boundaries, authentication boundaries).
  - **Threats:** Specific threats in each category.
  - **Mitigations:** How threats are mitigated (controls, patterns, monitoring).
- **Verification:** Check that threat models use STRIDE categories; threats and mitigations are documented.

#### Threat Model Documentation
- **MANDATORY:** Threat model MUST include:
  - **Context:** Bounded context name, trust tier, purpose.
  - **Assets:** Critical data, services, credentials.
  - **Entry points:** APIs, user input, external services, message queues.
  - **Trust boundaries:** Network boundaries, authentication boundaries, authorization boundaries.
  - **Threats:** STRIDE threats with risk ratings (High/Medium/Low).
  - **Mitigations:** Controls, patterns, monitoring for each threat.
  - **Owners:** Who owns each mitigation (team, role).
- **MANDATORY:** Threat model MUST be:
  - **Versioned:** Track changes over time (git history, version numbers).
  - **Reviewed:** Code-reviewed when updated (same process as code changes).
  - **Accessible:** Available to security team, architects, developers.
- **Verification:** Check that threat models are documented; threat models are versioned and reviewed.

### [TRUST TIER MAPPING]

#### Network Segmentation Expectations
- **MANDATORY:** Trust tiers MUST map to network segmentation:
  - **Tier H contexts:**
    - **MUST:** Isolated network segments (VPCs, subnets).
    - **MUST:** Strict firewall rules (deny by default).
    - **MUST:** mTLS between services (no plain HTTP).
  - **Tier M contexts:**
    - **MUST:** Network segmentation (VPCs, subnets).
    - **SHOULD:** mTLS between services (preferred).
    - **MUST:** Firewall rules (allowlist-based).
  - **Tier S contexts:**
    - **SHOULD:** Network segmentation (VPCs, subnets).
    - **MAY:** mTLS between services (optional).
- **Verification:** Check that trust tiers map to network segmentation; Tier H contexts are isolated.

#### Data Classification & Handling
- **MANDATORY:** Trust tiers MUST map to data classification:
  - **Tier H contexts:**
    - **MUST:** Handle sensitive data (PII, credentials, financial data).
    - **MUST:** Encrypt data at rest and in transit.
    - **MUST:** Strict access controls (least privilege).
  - **Tier M contexts:**
    - **MUST:** Handle business data (orders, products, user data).
    - **SHOULD:** Encrypt data at rest and in transit.
    - **MUST:** Access controls (role-based).
  - **Tier S contexts:**
    - **MAY:** Handle public data (catalogs, public APIs).
    - **SHOULD:** Encrypt data in transit (TLS).
- **Verification:** Check that trust tiers map to data classification; Tier H contexts handle sensitive data.

#### Authentication/Authorization Depth
- **MANDATORY:** Trust tiers MUST map to authentication/authorization depth:
  - **Tier H contexts:**
    - **MUST:** MFA for all operations.
    - **MUST:** Short-lived tokens (15 minutes or less).
    - **MUST:** Strict authorization (deny by default, explicit permissions).
  - **Tier M contexts:**
    - **MUST:** Authentication for all operations.
    - **SHOULD:** MFA for sensitive operations.
    - **MUST:** Token-based authorization (JWT, OAuth2).
  - **Tier S contexts:**
    - **MAY:** Authentication for protected operations.
    - **MAY:** Public endpoints (no authentication).
- **Verification:** Check that trust tiers map to authentication/authorization depth; Tier H contexts require MFA.

#### Audit & Logging Requirements
- **MANDATORY:** Trust tiers MUST map to audit & logging requirements:
  - **Tier H contexts:**
    - **MUST:** Comprehensive audit logs (all operations, access attempts).
    - **MUST:** Long retention (7+ years for compliance).
    - **MUST:** Real-time alerting (failed logins, privilege escalations).
  - **Tier M contexts:**
    - **MUST:** Audit logs for sensitive operations (create, update, delete).
    - **SHOULD:** Retention (1+ years).
    - **SHOULD:** Alerting (error rates, suspicious activity).
  - **Tier S contexts:**
    - **SHOULD:** Basic logs (errors, access logs).
    - **MAY:** Retention (30+ days).
- **Verification:** Check that trust tiers map to audit & logging requirements; Tier H contexts have comprehensive audit logs.

### [REQUIRED ARTIFACTS]

#### Threat Model Document
- **MANDATORY:** Tier H/M contexts MUST have threat model documents:
  - **Location:** `docs/threat-models/[ContextName].md` or `[ContextName]/docs/threat-model.md`.
  - **Format:** Markdown with sections for assets, entry points, trust boundaries, threats, mitigations.
  - **Template:** Use consistent template across contexts.
- **MANDATORY:** Threat model document MUST be:
  - **Updated:** When new external integrations or sensitive flows are added.
  - **Reviewed:** Code-reviewed when updated (same process as code changes).
  - **Accessible:** Available to security team, architects, developers.
- **Verification:** Check that Tier H/M contexts have threat model documents; threat models are updated and reviewed.

#### Context Map Integration
- **MANDATORY:** Threat models MUST be integrated with context map:
  - **MUST:** Document trust boundaries between contexts.
  - **MUST:** Document threats at context boundaries (cross-context communication).
  - **MUST:** Document mitigations for cross-context threats (ACL, event schemas, API contracts).
- **Verification:** Check that threat models are integrated with context map; cross-context threats are documented.

### [INTEGRATION WITH EXISTING RULES]

#### Architecture Rules
- **MANDATORY:** Threat modeling MUST align with `.cursor/rules/36-architecture.mdc`:
  - **MUST:** Threat models reference bounded contexts and trust tiers.
  - **MUST:** Trust boundaries align with context boundaries.
  - **MUST:** Mitigations respect architecture patterns (ports/adapters, ACL).
- **Verification:** Check that threat models align with architecture rules; trust boundaries align with context boundaries.

#### Security Rules
- **MANDATORY:** Threat modeling MUST align with `.cursor/rules/30-security.mdc`:
  - **MUST:** Threats map to OWASP Top 10 risks (A01-A10).
  - **MUST:** Mitigations reference security controls (authentication, authorization, encryption).
  - **MUST:** Threat models inform security testing (penetration testing, security audits).
- **Verification:** Check that threat models align with security rules; threats map to OWASP Top 10.

#### Observability Rules
- **MANDATORY:** Threat modeling MUST align with `.cursor/rules/32-observability.mdc` and `.cursor/rules/39-observability-security.mdc`:
  - **MUST:** Threat models reference observability requirements (logging, metrics, traces).
  - **MUST:** Mitigations include monitoring and alerting (detection, response).
  - **MUST:** Threat models inform observability design (what to log, what to alert on).
- **Verification:** Check that threat models align with observability rules; monitoring and alerting are included.

### [AGENT RESPONSIBILITIES]

#### @architect
- **MANDATORY:** @architect MUST:
  - **Create threat models:** For Tier H/M contexts during architecture design.
  - **Document trust boundaries:** In context map and threat models.
  - **Review threat models:** When contexts are updated or new integrations are added.
- **Verification:** Check that @architect creates and reviews threat models.

#### @security-auditor
- **MANDATORY:** @security-auditor MUST:
  - **Review threat models:** Validate threats and mitigations.
  - **Identify gaps:** Missing threats or weak mitigations.
  - **Recommend improvements:** Strengthen mitigations, add missing threats.
- **Verification:** Check that @security-auditor reviews threat models; gaps are identified and addressed.

### [VERIFICATION]

- **Threat models:** Check that Tier H/M contexts have threat models; threat models are updated when changes occur.
- **STRIDE categories:** Check that threat models use STRIDE categories; threats and mitigations are documented.
- **Trust tier mapping:** Check that trust tiers map to network segmentation, data classification, authentication/authorization, audit/logging.
- **Artifacts:** Check that Tier H/M contexts have threat model documents; threat models are integrated with context map.
- **Agent responsibilities:** Check that @architect and @security-auditor fulfill threat modeling responsibilities.

**See also:**
- `.cursor/rules/36-architecture.mdc` — Architecture rules (bounded contexts, trust tiers)
- `.cursor/rules/30-security.mdc` — Security standards (OWASP Top 10, security controls)
- `.cursor/rules/32-observability.mdc` — Observability standards (logging, metrics, traces)
- `.cursor/rules/39-observability-security.mdc` — Observability & security integration
- `docs/architecture/` — Architecture documentation (context maps, threat models)
