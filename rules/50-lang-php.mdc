---
description: "PHP standards — modern, typed, Laravel-aligned, and architecture-safe."
required: false
category: "language"
subcategory: "php"
globs:
  - "src/**/*.php"
  - "app/**/*.php"
  - "modules/**/*.php"
  - "contexts/**/*.php"
  - "tests/**/*.php"
---

[PHP — SCOPE]

- Applies to all first-party PHP code (domain, application, controllers, console commands, jobs, tests).
- Excludes vendor/third-party packages.
- For Laravel projects, this rule is **in addition** to the detailed guidelines in:
  - `docs/laravel-php-ai-guidelines.md` (canonical Laravel/PHP style & conventions).

[LANGUAGE & VERSION]

- Version:
  - Target **PHP 8.2+** (or project-wide minimum if higher).
  - Use `declare(strict_types=1);` at the top of all non-legacy PHP files.
- Types:
  - Use native type declarations for parameters, return types, and properties.
  - Use short nullable notation (`?Type`) instead of `Type|null`.
  - Prefer typed properties over docblocks; use docblocks only for:
    - Generics (collections),
    - Array shapes,
    - Non-obvious semantics.

[STYLE, DOCBLOCKS & NAMING]

- Follow PSR-1/PSR-12 strictly; enforce via `phpcs`/`phpcbf`.
- Naming:
  - Classes: PascalCase (`UserService`, `OrderStatus`).
  - Methods/variables: camelCase (`getUserName`, `$firstName`).
  - Constants: SCREAMING_SNAKE_CASE.
- Docblocks:
  - No docblocks for fully type-hinted methods unless adding meaningful description.
  - When documenting iterables, use generics:
    - `/** @return Collection<int, User> */`
  - Use array shape notation for fixed keys.
  - Import classes used in docblocks; avoid fully-qualified names inside `@return`/`@param`.
- Control flow:
  - Prefer early returns; avoid deep nesting and unnecessary `else`.
  - Always use curly braces, even for single-line `if`/loops.
  - Ternaries only for simple cases; multi-line ternaries must remain readable.

[ARCHITECTURE INTEGRATION — CLEAN + HEX + DDD]

- **MANDATORY:** All PHP backend code MUST follow Clean Architecture, Hexagonal Architecture, and DDD patterns as defined in `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`.
- **These architecture rules are BINDING for PHP backends** — violations will be rejected.
- **MANDATORY:** For backend services, PHP code MUST adhere to `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`. This is a binding constraint, not optional guidance.
- **Domain/Application MUST be framework-free:**
  - Domain layer MUST NOT extend framework base classes (no Model extends Eloquent, no Controller base in Domain).
  - Domain layer MUST NOT use facades or helper functions that touch IO (DB, HTTP, cache) directly.
  - Domain layer MUST NOT import ORM types (e.g., `@Entity`, `@Table`, `@Column`), HTTP types (e.g., `Request`, `Response`), or framework types.
  - Application layer MUST orchestrate use cases, call repositories, but MUST NOT be controllers themselves.
  - Application layer MUST NOT import framework classes or use facades.
- **REJECTION CRITERIA:**
  - PHP code that violates `.cursor/rules/36-architecture.mdc` layering rules → **REJECT**.
  - PHP code that violates `.cursor/rules/44-ddd.mdc` domain purity rules → **REJECT**.
  - Domain/Application extending framework base classes or using facades → **REJECT**, use plain PHP classes and ports/adapters.
  - Controllers with business logic → **REJECT**, move to Application use cases.

- Domain layer (`Domain/` in contexts/modules):
  - **FORBIDDEN:** No framework dependencies whatsoever.
  - **FORBIDDEN:** `Request`, `Response`, `Controller`, `Model`, `DB`, `Auth`, `Config`, `Cache`, `Queue`, `Mail`, `Log`, `Validator`, `Gate`, `Policy`, `Route`, `Schema`, `Migration`, or any Laravel/Symfony class.
  - **FORBIDDEN:** Laravel facades (`\Illuminate\Support\Facades\*`) or helper functions (`request()`, `auth()`, `config()`, etc.).
  - Contains:
    - Entities, Value Objects, Domain Services, Domain Events, Repository interfaces.
  - All business invariants live here.
- Application layer (`Application/`):
  - **FORBIDDEN:** Direct framework dependencies (same as Domain).
  - **FORBIDDEN:** Laravel facades or helper functions.
  - Use Cases, Commands/Queries, Application Services.
  - Depends on Domain; can depend on simple DTOs and interfaces.
  - No direct ORM/HTTP/framework usage; use ports defined in Domain/Application.
- **REJECTION CRITERIA:**
  - Domain/Application code importing Laravel/Symfony classes → **REJECT**, use ports/adapters.
  - Use case using `\Illuminate\Http\Request` or `request()` helper → **REJECT**, pass DTOs.
  - Domain entity extending `Illuminate\Database\Eloquent\Model` → **REJECT**, use plain PHP classes.
- Interface layer (`Interface/`, HTTP/CLI adapters):
  - Controllers, console commands, route handlers, view models.
  - Maps HTTP/CLI → Application use cases (input DTOs) and maps results → HTTP/JSON/View models.
  - **MANDATORY:** Controllers are thin; delegate to Application use cases.
  - **MANDATORY:** Controllers MUST NOT contain business logic, validation rules, or persistence logic.
  - **FORBIDDEN:** Business logic in controllers → **REJECT**, move to Application use cases.
  - **FORBIDDEN:** Controllers accessing repositories directly → **REJECT**, use Application use cases.
- Infrastructure layer (`Infrastructure/`):
  - ORM entities, Eloquent models, repositories, queue handlers, mailers, external API clients.
  - Implements ports (interfaces) from Domain/Application.
- Forbidden patterns:
  - Business logic inside controllers, jobs, listeners, or Eloquent models.
  - Domain code depending on Laravel facades or framework-specific classes.
  - Cross-context DB access or using one bounded context's models in another.
  - Controllers accessing repositories directly → **REJECT**, use Application use cases.

[LARAVEL CONVENTIONS]

- Follow Laravel's documented conventions by default; diverge only with strong reasons.
- **MANDATORY:** Laravel conventions apply ONLY to Interface and Infrastructure layers.
- **MANDATORY:** Domain and Application layers MUST remain framework-free (no Laravel conventions in Domain/Application).
- Routes:
  - URLs: kebab-case.
  - Route names: camelCase.
  - Controllers: plural resource controllers where applicable.
- Controllers:
  - **MANDATORY:** Keep thin; delegate to Application use cases.
  - **MANDATORY:** Controllers MUST NOT contain business logic (see `.cursor/rules/36-architecture.mdc`).
  - Use dependency injection; avoid resolving services via facades where reasonable.
- Validation:
  - Prefer Form Requests and array notation for multiple rules.
  - Custom validation rules in snake_case.
- Configuration:
  - Config file names kebab-case; keys snake_case.
  - Use `config()` helper; avoid `env()` outside config.
- See `docs/laravel-php-ai-guidelines.md` for detailed Laravel conventions, naming standards, and examples.

[SECURITY & DATA SAFETY]

- Input handling:
  - Validate and sanitize all untrusted input; never trust `Request` data directly.
  - Use Laravel’s validation, policies, gates, and authorization for access control.
- Persistence:
  - Use prepared statements/ORM; never build SQL via string concatenation.
  - Avoid dynamic queries without parameter binding.
- Output:
  - Escape data in views; use Blade’s escaping by default.
- Secrets & credentials:
  - Never hard-code secrets; use env variables/secret managers.
- Authentication & authorization:
  - Keep AuthN/AuthZ logic in appropriate contexts; no “role checks” scattered randomly.
  - Prefer policies/gates over ad-hoc `if ($user->role === 'admin')` logic.

[PERFORMANCE & SCALABILITY]

- Query behavior:
  - Avoid N+1 queries; use eager loading where necessary.
  - Use pagination/scrolling for large result sets.
- Caching:
  - Cache expensive computations and queries where appropriate (Redis/APCu).
  - Invalidate cache explicitly on domain events or state changes.
- PHP runtime:
  - Enable OPCache in production.
  - Avoid premature micro-optimizations; favor clarity unless profiling says otherwise.

[TESTING & TOOLING]

- Testing:
  - Use `phpunit` or Pest with:
    - Unit tests for Domain and Application.
    - Integration tests for Infrastructure and Interface boundaries.
  - Mock external services; avoid real network calls in tests.
  - Ensure critical domain invariants are covered (happy path + edge cases + error paths).
- Static analysis & QA:
  - Run `phpstan` (or Psalm) at a strict level (e.g. `--level=max`) for all first-party code.
  - Keep the baseline clean; do not suppress critical issues.
- CI pipeline (baseline commands):
  - `composer install` (or `composer install --no-dev` for prod images).
  - `phpcs --standard=PSR12` (or project standard).
  - `phpstan analyse` at strict level.
  - `composer audit`.
  - `./vendor/bin/phpunit` or `./vendor/bin/pest`.

[ANTI-PATTERNS]

- Anemic models used as dumb structs while controllers hold all logic.
- Direct use of global helpers/facades in Domain/Application code (`request()`, `config()`, `auth()`).
- Large God classes/services that mix responsibilities across multiple bounded contexts.
- Inline SQL, hand-built JSON strings, or manual serialization where the framework provides safe abstractions.
- Copy-pasting validation rules or business logic across controllers instead of centralizing in Domain/Application.
 
[CHANGE-SAFETY]
- **MANDATORY:** For PHP backend services (Tier M/H contexts and non-trivial APIs), language-specific practices are binding on top of change-discipline rules:
  - Bugfixes MUST follow `.cursor/rules/45-bugfix-protocol.mdc` (reproduce, regression test, minimal fix, guard surrounding behavior).
  - Behavioral changes and new features MUST follow `.cursor/rules/23-change-control.mdc` and `.cursor/rules/46-regression-discipline.mdc` (classification, tests as contracts, explicit assessment of breaking vs non-breaking).
  - Refactors MUST respect `.cursor/rules/47-diff-discipline.mdc` (tight diff scope, no bundled large refactors with small fixes).
  - Public API and cross-context contract changes MUST follow `.cursor/rules/35-api-lifecycle.mdc` and `.cursor/rules/48-doc-sync.mdc` (versioning, migration, documentation).
- **MANDATORY:** PHP agents and contributors MUST NOT:
  - Delete or weaken tests solely to "get CI green" without updating specs/ADRs and following `.cursor/rules/23-change-control.mdc` and `.cursor/rules/46-regression-discipline.mdc`.
  - Change controller or HTTP behavior that is externally consumed without aligning with `.cursor/rules/35-api-lifecycle.mdc` and `.cursor/rules/48-doc-sync.mdc`.
  - Introduce configuration or flag behavior that bypasses `.cursor/rules/3E-config-environments.mdc` or `.cursor/rules/3F-feature-flags-rollouts.mdc`.

[VERIFICATION]

- For PHP changes:
  - Confirm files have `declare(strict_types=1);` and proper typing.
  - **MANDATORY:** Check that domain code is framework-free and follows Clean/Hex/DDD layering (see `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`).
  - **MANDATORY:** Verify Domain/Application layers have no framework dependencies.
  - **MANDATORY:** Verify controllers are thin (no business logic).
  - Run the standard toolchain (phpcs, phpstan, tests).
- For Laravel:
  - Cross-check structure/naming against `docs/laravel-php-ai-guidelines.md`.
  - **MANDATORY:** Ensure controllers are thin and domain logic is in Domain/Application layers.
  - **MANDATORY:** Verify Domain/Application layers do not extend Eloquent Models or use Laravel facades.
- **MANDATORY:** PHP language rules are **integrated with** and **enforce** architecture rules — they are not separate concerns.
- **See also:**
  - `.cursor/rules/36-architecture.mdc` — Clean Architecture, Hexagonal Architecture, DDD patterns (BINDING)
  - `.cursor/rules/44-ddd.mdc` — Domain-Driven Design methodology (BINDING)
  - `.cursor/rules/23-change-control.mdc` — Change classification and contracts
  - `.cursor/rules/45-bugfix-protocol.mdc` — Bugfix protocol (reproduce, test, fix, guard)
  - `.cursor/rules/46-regression-discipline.mdc` — Tests as contracts
  - `.cursor/rules/47-diff-discipline.mdc` — Diff scope and blast radius
  - `.cursor/rules/48-doc-sync.mdc` — Spec & documentation sync
  - `.cursor/rules/35-api-lifecycle.mdc` — API lifecycle, compatibility, deprecation
  - `docs/laravel-php-ai-guidelines.md` — Laravel/PHP style & conventions
  - `examples/refactoring/clean-architecture/` — Before/after examples for architecture violations
