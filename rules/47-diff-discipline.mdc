---
description: "Diff discipline: scoped changes and blast-radius control."
category: "governance"
subcategory: "diff-discipline"
required: true
globs:
  - "src/**"
  - "app/**"
  - "tests/**"
---

[SOURCE OF TRUTH]
- Editable source: `rules/47-diff-discipline.mdc`
- Generated/consumed copy: `.cursor/rules/47-diff-discipline.mdc` (keep references intact)

[INTENT]
- Define diff discipline and blast-radius control for changes.

[APPLICABILITY]
- Applies to all diffs; scope/boundary rules are binding unless an explicit risk override per `.cursor/rules/3G-risk-overrides.mdc` is provided.

[CONCEPTS]
- Change scope:
  - Change scope is the minimal set of files, modules, and behaviors that must change to accomplish a specific, clearly stated goal (e.g., fix a specific bug, add a small feature, refactor one module).
  - Scope is defined in terms of domain behavior and bounded contexts (see `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`), not just technical layers; a "small" change in a Tier H bounded context can still be high risk.
- Blast radius:
  - Blast radius is the set of behaviors, modules, bounded contexts, and environments that could be affected by a changeâ€”whether intentionally or accidentally.
  - Larger blast radius demands stronger controls: more tests, deeper review, stricter change-control, and more careful rollout per `.cursor/rules/3D-operations.mdc`, `.cursor/rules/34-ci.mdc`, and `.cursor/rules/23-change-control.mdc`.
- Diff discipline:
  - Diff discipline is the practice of aligning actual code diffs with the declared scope and goal, minimizing surprise and reducing the risk of unintended regressions or architectural violations.


[BASE RULES]
- Stated scope and goal:
  - Every change (PR, patch, or agent action) MUST have a clearly stated scope and goal expressed in domain terms (e.g., "fix double-charging on order retries", "add pagination to orders list") rather than vague technical phrasing.
  - The diff MUST be limited to:
    - Files and modules directly related to that goal,
    - Necessary wiring (e.g., dependency injection, imports, routes, configuration),
    - Necessary test and documentation updates required by `.cursor/rules/31-testing.mdc` and `.cursor/rules/48-doc-sync.mdc`.
- Prohibited patterns:
  - Agents and contributors MUST NOT:
    - Perform broad refactors, global renames, or cross-context changes under a narrow task unless the user explicitly broadens the scope and change-control is applied.
    - Introduce unrelated "drive-by" changes (style-only tweaks, incidental formatting, opportunistic refactors) in the same diff as a critical bugfix or small feature, unless clearly justified and documented.
  - Refactors that span multiple bounded contexts or alter architecture must be treated as explicit refactoring tasks governed by `.cursor/rules/3A-anti-patterns.mdc`, `.cursor/rules/36-architecture.mdc`, and `.cursor/rules/23-change-control.mdc`, not as incidental side effects.
- Tier H/M stricter discipline:
  - For Tier H and Tier M contexts (see `.cursor/rules/36-architecture.mdc`), diff scope MUST be particularly tight and explicitly justified:
    - Changes SHOULD be as small and localized as possible.
    - Cross-context effects MUST be identified and controlled via ACLs/events per `.cursor/rules/38-anti-corruption-events.mdc`.
  - Large, multi-concern changes that touch Tier H contexts MUST be broken down into smaller, safer slices in line with `.cursor/rules/43-fdd.mdc`.


[AGENT BEHAVIOR]
- Before editing:
  - Agents MUST:
    - Restate the requested change in terms of domain behavior and scope.
    - List the modules/files they intend to touch and why, including:
      - Primary implementation locations,
      - Required wiring/config changes,
      - Tests and docs that need updating.
  - If the requested change is ambiguous or dangerously broad relative to risk (e.g., "cleanup all user code" in a Tier H context), agents MUST narrow it to a safe, minimal slice or require explicit risk acceptance and a broader change-control plan per `.cursor/rules/23-change-control.mdc`.
- After editing:
  - Agents MUST:
    - Summarize which files actually changed and how that compares to the initial scope.
    - Call out any scope expansions explicitly (e.g., "also had to adjust shared mapper X to satisfy architecture constraints in `.cursor/rules/36-architecture.mdc`").
    - Ensure that new changes remain consistent with architecture boundaries (no cross-context imports, no business logic in controllers, etc.).
  - When the user has requested a "minor" or "small" change, agents MUST:
    - Refuse to perform wide-ranging refactors, renames, or architectural overhauls in the same diff unless the user explicitly agrees to a broader scope and the necessary governance steps.
- Integration with bugfix and regression discipline:
  - For bugfixes, agents MUST follow `rules/45-bugfix-protocol.mdc` and keep diffs focused on reproducing, fixing, and guarding the specific bug plus necessary tests.
  - For test changes, agents MUST follow `rules/46-regression-discipline.mdc` and avoid mixing large test overhauls with unrelated behavior changes unless explicitly scoped as such.


[VERIFICATION / CHECKS]
- For `@code-reviewer`:
  - MUST verify that the diff content matches the declared scope and goal:
    - Files changed correspond to the behavior described,
    - Unrelated drive-by changes are either justified or removed.
  - MUST flag and, where necessary, reject:
    - Wide-ranging refactors bundled with small bugfixes,
    - Cross-context changes that have not gone through architecture review and change-control,
    - Style-only changes mixed into critical fixes without justification.
  - SHOULD encourage splitting large multi-concern changes into smaller, reviewable slices aligned with `.cursor/rules/43-fdd.mdc`.
- For `@architect` / `@owner`:
  - MUST ensure that changes that cross bounded contexts, adjust public contracts, or affect Tier H/M components are handled as explicit, scoped tasks with appropriate architecture validation per `.cursor/rules/36-architecture.mdc` and `.cursor/rules/35-api-lifecycle.mdc`.
  - SHOULD enforce that architecture-impacting refactors are not smuggled into unrelated tickets but are instead planned, documented, and tested as their own work items.
- For CI / policy checks:
  - While automated enforcement of scope is limited, policy and review guidelines SHOULD highlight:
    - Critical modules or contexts where large diffs require additional scrutiny,
    - Heuristics (e.g., number of files changed, cross-context imports) that can flag risky diffs for deeper review.

