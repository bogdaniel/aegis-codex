---
description: "Testing standards: coverage, determinism, and contracts."
required: true
category: "topic"
subcategory: "testing"
globs:
  - "src/**"
  - "app/**"
  - "domain/**"
  - "tests/**"
---

[TESTING BASELINE]
- Coverage: target ≥80% critical code paths; prioritize domain logic, edges, regression tests for fixed bugs; fail on drops in critical modules.
- Determinism: tests must be hermetic, order-independent, and parallel-safe; no external network/clock randomness; control time/randomness/IO via fakes/mocks; avoid sleep-based waits.
- Structure: Arrange-Act-Assert; descriptive names by intent; avoid testing implementation details.
- Scope: unit pure logic with mocked deps; integration with seeded data and cleanup; minimal E2E on critical flows; use containers/fakes for infra.
- Isolation: small explicit fixtures; no global state; reset between tests; limit parallelism for shared resources.
- CI gating: block on flakiness; no silent skips; include coverage reports; run lint/type/**architecture checks**/security checks with tests.

[TESTING & ARCHITECTURE]
- **MANDATORY:** All tests MUST respect architecture layering as defined in `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`.
- **MANDATORY:** For non-trivial services, tests MUST:
  - **Target Application layer use cases as primary unit boundaries** (not controllers, not repositories).
  - Use Domain tests for invariants (aggregate boundaries, value object validation, domain events).
  - Keep Infrastructure/HTTP tests as integration/E2E (test adapters, not business logic).
- **MANDATORY:** Test structure MUST reflect architecture layers:
  - **Domain tests:** Test entities, value objects, domain services, domain events, aggregate invariants.
  - **Application tests:** Test use cases (primary unit boundary), commands/queries, application services.
  - **Infrastructure tests:** Test adapters (repositories, external API clients, message publishers).
  - **Interface tests:** Test HTTP controllers, CLI commands, message consumers (thin adapters only).
- **MANDATORY:** Test file organization MUST respect bounded contexts:
  - Tests organized by bounded context (e.g., `tests/IdentityContext/Application/UseCases/RegisterUser.test.ts`).
  - Cross-context tests use public API modules (same as production code).
  - Test utilities in `tests/` or `__tests__/` directories.

[TEST FILE STRUCTURE]
- Test file import patterns:
  - Can import from any layer within their context (for testing purposes).
  - Can import Infrastructure adapters directly (for test doubles and mocks).
  - MUST use public API modules for cross-context imports (same as production code).
  - Test utilities should be in `tests/` or `__tests__/` directories.
- Mock patterns:
  - Mocks should implement ports (interfaces), not concrete classes.
  - Test doubles should be in test files or `tests/fixtures/` directories.
  - Prefer interface-based mocks over class-based mocks for better testability.

[CHANGE-DISCIPLINE INTEGRATION]
- **MANDATORY:** For backend/domain code, testing rules are binding and integrated with change-discipline:
  - New behavior MUST come with tests covering happy path, at least one failure path, and at least one edge case (where applicable).
  - Bugfixes MUST follow `.cursor/rules/45-bugfix-protocol.mdc` (reproduce, confirm, fix, guard with regression tests).
  - Tests MUST NOT be deleted or weakened without justification and spec/ADR updates per `.cursor/rules/46-regression-discipline.mdc`.
  - Changes MUST respect diff scope per `.cursor/rules/47-diff-discipline.mdc`; test changes must align with declared change scope.
- **MANDATORY:** AI agents MUST treat missing tests for new behavior as a **blocking issue**; they MUST refuse to implement behavior changes without corresponding tests unless a valid risk override per `.cursor/rules/3G-risk-overrides.mdc` is explicitly provided.

[AGENT BEHAVIOR & REFUSAL DUTIES]
- **MANDATORY:** AI agents (including `@implementer`, `@test-engineer`, `@code-reviewer`) MUST:
  - Refuse to implement bugfixes without regression tests per `.cursor/rules/45-bugfix-protocol.mdc`.
  - Refuse to delete or weaken tests without going through `.cursor/rules/23-change-control.mdc` and `.cursor/rules/46-regression-discipline.mdc`.
  - Refuse to implement new behavior without tests covering the behavior.
  - Only proceed with test violations if a valid `RISK_OVERRIDE` block is explicitly provided by the user, following `.cursor/rules/3G-risk-overrides.mdc`.

[VERIFICATION]
- Provide exact commands to run tests per stack (e.g., `npm test -- --runInBand`, `pytest -q`, `go test ./...`, `cargo test`, `phpunit`) and include lint/type where relevant.
- **Policy Validation:** Agent behavior MUST comply with policy scenarios in `tests/policies/`. If policy validation fails, tighten relevant `.cursor/rules/*.mdc` files (see `tests/policies/README.md`).

**See also:**
- `.cursor/rules/23-change-control.mdc` — Change classification and contracts
- `.cursor/rules/45-bugfix-protocol.mdc` — Bugfix protocol (reproduce, test, fix, guard)
- `.cursor/rules/46-regression-discipline.mdc` — Tests as contracts
- `.cursor/rules/47-diff-discipline.mdc` — Diff scope and blast radius
- `.cursor/rules/3G-risk-overrides.mdc` — Risk override protocol
