---
description: "CI/CD standards: gates, supply chain, and rollout safety."
required: true
category: "topic"
subcategory: "ci"
globs:
  - "**/*"
---

[CI/CD BASELINE]
- Pipeline stages: lint/format/type-check → **architecture checks** → unit tests + coverage → integration/smoke (DB/cache/API) → security scans (deps + secrets + static security) → build/package + SBOM/signing.
- Required gates: block on lint/type errors, **architecture violations**, test failures/flakiness, coverage drops in critical paths, and High/Critical vulnerabilities unless risk-accepted with expiry; fail if secrets scan hits.
- **MANDATORY:** Architecture checks MUST run before tests and MUST fail the pipeline on violations.
- **MANDATORY:** CI failures on architecture/security/change-discipline/test rules are **blocking, not advisory**; the pipeline MUST NOT pass with violations unless a valid risk override per `.cursor/rules/3G-risk-overrides.mdc` is documented and time-bounded.
- Supply chain: pin dependencies/locks; hermetic builds when possible; avoid `latest`; cache verified deps; publish SBOM as artifact.
- Deployment: prefer canary/blue-green; health/readiness checks mandatory; auto-rollback on triggers (p95 latency +20%/15m, error rate +0.5%/10m, critical security event).
- Environment/secrets: config via env/secret manager; least-privilege CI tokens; redact secrets from logs.

[ARCHITECTURE & LANGUAGE GATES — MANDATORY]
- **MANDATORY:** CI MUST run architecture/import rules for each language as a **blocking gate** (pipeline fails on violations):
  - For TypeScript: ESLint (no-restricted-imports) + path alias checks
  - For PHP: Deptrac (or equivalent) enforcing domain/app/infra layering
  - For Java: ArchUnit (or equivalent) enforcing package boundaries
  - For C#: ArchUnit.NET (or equivalent) enforcing assembly boundaries
- **MANDATORY:** Fail the pipeline if:
  - Domain imports framework/infra packages → **REJECT**, fail pipeline
  - Domain imports from Infrastructure/Interface aliases (e.g., `@context/infra/*`, `@context/interface/*`) → **REJECT**, fail pipeline
  - Cross-context imports bypass ACL / application ports → **REJECT**, fail pipeline
  - Missing path aliases (deep relative imports beyond 1 level) → **REJECT**, fail pipeline
  - Missing bounded contexts (code organized by technical layers only) → **REJECT**, fail pipeline
  - Missing trust tiers for bounded contexts → **REJECT**, fail pipeline
- **MANDATORY:** Architecture checks MUST reference `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc` as binding constraints.

[ARCHITECTURE ENFORCEMENT]
- **MANDATORY:** Required CI checks (all must pass, pipeline fails on any violation):
  - Static analysis (ESLint/Deptrac/ArchUnit) must pass → **FAIL PIPELINE** if violations found.
  - Architecture dependency checks must pass (layer dependencies, cross-context imports) → **FAIL PIPELINE** if violations found.
  - Public API module exports must be documented (JSDoc/TSDoc headers present) → **FAIL PIPELINE** if missing.
  - No cross-context domain/infra imports (must use public API modules) → **FAIL PIPELINE** if violations found.
  - For TypeScript projects: path aliases must be used (no relative imports beyond 1 level) → **FAIL PIPELINE** if violations found.
  - Other languages: enforce module/package boundaries using ecosystem-appropriate tools (Deptrac, package boundaries, etc.) → **FAIL PIPELINE** if violations found.
  - Domain layer MUST NOT import from Infrastructure/Interface → **FAIL PIPELINE** if violations found.
  - Application layer MUST NOT import from Infrastructure/Interface → **FAIL PIPELINE** if violations found.
- **MANDATORY:** Architecture checks MUST validate against `.cursor/rules/36-architecture.mdc` and `.cursor/rules/44-ddd.mdc`.
- Pre-commit hooks:
  - Run architecture checks before commit (static analysis, dependency validation).
  - **MANDATORY:** Block commits with violations (layer dependencies, cross-context imports, path alias violations).
- PR requirements:
  - Architecture review for public API changes (new exports, breaking changes).
  - Documentation updates for new public APIs (JSDoc/TSDoc headers).
  - **MANDATORY:** Verify no architecture violations introduced (use static analysis tools) → **BLOCK MERGE** if violations found.
- Policy validation:
  - **MANDATORY:** Policy scenarios in `tests/policies/` MUST be validated when rules change.
  - **MANDATORY:** If policy validation fails, tighten relevant `.cursor/rules/*.mdc` files.
  - Policy scenarios validate agent behavior against critical policies (security, testing, architecture).
  - See `tests/policies/README.md` for policy scenario structure and validation criteria.

[CHANGE-DISCIPLINE ENFORCEMENT]
- **MANDATORY:** For Tier M/H services and bounded contexts:
  - CI MUST enforce that behavior changes are accompanied by appropriate tests and change-control metadata:
    - Changes that touch core logic without any test diffs MUST be flagged for review as potential violations of `.cursor/rules/23-change-control.mdc`, `.cursor/rules/45-bugfix-protocol.mdc`, and `.cursor/rules/46-regression-discipline.mdc`.
    - Bugfix branches MUST contain regression test additions/updates or an explicitly documented and approved exception.
  - CI MUST verify that:
    - API artifacts (OpenAPI/GraphQL specs, event schemas) are updated when API-related files change (`.cursor/rules/35-api-lifecycle.mdc`, `.cursor/rules/38-anti-corruption-events.mdc`, `.cursor/rules/48-doc-sync.mdc`).
    - Architecture/ADR/docs are updated when contract or cross-context behavior changes are detected (e.g., public API modules, domain events), in line with `.cursor/rules/48-doc-sync.mdc` and `.cursor/rules/36-architecture.mdc`.
- **MANDATORY:** When policy scenarios in `tests/policies/` detect non-compliant agent behavior around bugfixing, regression discipline, diff discipline, or doc-sync:
  - The relevant rules (`.cursor/rules/23-change-control.mdc`, `.cursor/rules/45-bugfix-protocol.mdc`, `.cursor/rules/46-regression-discipline.mdc`, `.cursor/rules/47-diff-discipline.mdc`, `.cursor/rules/48-doc-sync.mdc`, `.cursor/rules/35-api-lifecycle.mdc`) MUST be reviewed and tightened before merging changes.
  - Deviations MUST NOT be "accepted as-is" in CI; either the rule or the scenario is outdated, and the repository MUST converge them.

[AGENT BEHAVIOR & REFUSAL DUTIES]
- **MANDATORY:** CI/CD configurations MUST enforce architecture, security, and change-discipline rules as blocking gates.
- **MANDATORY:** AI agents (including `@devops`, `@code-reviewer`) MUST:
  - Refuse to configure CI pipelines that skip or downgrade architecture/security/change-discipline checks.
  - Refuse to mark architecture/security/change-discipline violations as "warnings" or "advisory" for Tier M/H services.
  - Only proceed with non-blocking CI configurations if a valid `RISK_OVERRIDE` block is explicitly provided by the user, following `.cursor/rules/3G-risk-overrides.mdc`.

[VERIFICATION]
- Provide local pipeline command (e.g., `npm run lint && npm test`, `go test ./...`, `cargo fmt -- --check && cargo clippy && cargo test`) and reference CI workflow path.

**See also:**
- `.cursor/rules/36-architecture.mdc` — Architecture rules enforced in CI
- `.cursor/rules/30-security.mdc` — Security rules enforced in CI
- `.cursor/rules/31-testing.mdc` — Testing rules enforced in CI
- `.cursor/rules/23-change-control.mdc` — Change-discipline rules enforced in CI
- `.cursor/rules/3G-risk-overrides.mdc` — Risk override protocol

[ARCHITECTURE CHECK EXAMPLES]

### TypeScript ESLint Configuration

Example `.eslintrc.json` with architecture enforcement:

```json
{
  "overrides": [
    {
      "files": ["**/Domain/**/*.ts", "**/domain/**/*.ts"],
      "rules": {
        "no-restricted-imports": [
          "error",
          {
            "patterns": [
              {
                "group": ["**/infra/**", "**/Infrastructure/**", "**/interface/**", "**/Interface/**"],
                "message": "Domain layer MUST NOT import from Infrastructure or Interface. Use ports/adapters pattern."
              }
            ]
          }
        ]
      }
    },
    {
      "files": ["**/*.ts"],
      "rules": {
        "no-restricted-imports": [
          "error",
          {
            "patterns": [
              {
                "group": ["../../*", "../../../*"],
                "message": "Deep relative imports forbidden. Use path aliases (@context/layer/*)."
              }
            ]
          }
        ]
      }
    }
  ]
}
```

### PHP Deptrac Configuration

Example `deptrac.yaml` for layer enforcement:

```yaml
paths:
  - ./src

layers:
  - name: Domain
    collectors:
      - type: directory
        regex: .*Domain.*
  - name: Application
    collectors:
      - type: directory
        regex: .*Application.*
  - name: Infrastructure
    collectors:
      - type: directory
        regex: .*Infrastructure.*
  - name: Interface
    collectors:
      - type: directory
        regex: .*Interface.*

ruleset:
  Domain:
    - Application
  Application:
    - Domain
    - Infrastructure
  Infrastructure:
    - Domain
    - Application
  Interface:
    - Domain
    - Application
```

See `docs/tooling/` for more examples (if created).

[CI/CD AUTOMATION]

### GitHub Actions Workflows

**Architecture Check Workflow:** `.github/workflows/aegis-architecture-check.yml`
- Runs on: Pull requests and pushes to main branch
- Checks:
  - TypeScript: Path aliases, deep relative imports, cross-context imports
  - PHP: Deptrac layer dependency checks (if configured)
  - Java: Package boundary checks (requires ArchUnit setup)
  - C#: Architecture checks (requires ArchUnit.NET setup)
  - Public API module documentation (JSDoc/TSDoc headers)

**Existing Workflows:**
- `.github/workflows/aegis-ci.yml` — Lint, format, tests
- `.github/workflows/aegis-security.yml` — Dependency audits, security scans
- `.github/workflows/aegis-policy-check.yml` — Policy validation

### Pre-Commit Hooks

**Pre-Commit Configuration:** `.pre-commit-config.yaml`
- Install: `pip install pre-commit && pre-commit install`
- Run manually: `pre-commit run --all-files`
- Hooks:
  - ESLint with architecture rules (TypeScript)
  - Deep relative import checks
  - PHP: PHPCS + PHPStan
  - Rust: fmt + clippy
  - Go: fmt + vet
  - Python: Black + Ruff

**Standalone Script:** `scripts/pre-commit-architecture-check.sh`
- Can be used as git pre-commit hook: `ln -s ../../scripts/pre-commit-architecture-check.sh .git/hooks/pre-commit`
- Run manually: `./scripts/pre-commit-architecture-check.sh`
- Checks:
  - Deep relative imports (../../ or deeper)
  - Cross-context direct imports
  - Public API module documentation
  - ESLint with architecture rules

### Local Pipeline Commands

**TypeScript/JavaScript:**
```bash
# Run architecture checks
cd test/example-app
npm run lint  # Uses .eslintrc.json with architecture rules
npm run type-check
npm test

# Or use pre-commit
pre-commit run --all-files
```

**PHP:**
```bash
# Run Deptrac (if configured)
vendor/bin/deptrac analyse

# Or use pre-commit
pre-commit run --all-files
```

**All Languages:**
```bash
# Run pre-commit hooks
pre-commit run --all-files

# Or use standalone script
./scripts/pre-commit-architecture-check.sh
```
