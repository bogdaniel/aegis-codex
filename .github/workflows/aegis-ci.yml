# CI for unmerged code (PRs, pushes to default branch). Adjust `branches` to match your default branch.
name: Aegis CI

on:
  pull_request:
  push:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  lint-and-format:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Node/TS lint/format/test only if package manifests exist.
      - name: Setup Node
        if: hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != ''
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Node dependencies (npm)
        if: hashFiles('package-lock.json') != ''
        run: npm ci

      - name: Install Node dependencies (pnpm)
        if: hashFiles('pnpm-lock.yaml') != ''
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: pnpm install
        if: hashFiles('pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile

      - name: ESLint
        if: hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != ''
        run: npm run lint --if-present || pnpm lint --if-present

      - name: Prettier
        if: hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != ''
        run: npx prettier --check "**/*.{js,ts,tsx,json,md,yml,yaml}" || pnpm prettier --check "**/*.{js,ts,tsx,json,md,yml,yaml}"

      # PHP lint/analysis if composer is present.
      - name: PHP lint/stan
        if: hashFiles('composer.lock') != ''
        run: |
          composer install --no-interaction --prefer-dist
          vendor/bin/phpcs --standard=PSR12 || true  # fail-soft; tighten as needed
          vendor/bin/phpstan analyse --no-progress --level=max || true

      # Rust fmt/clippy if Cargo.toml exists.
      - name: Rust fmt + clippy
        if: hashFiles('Cargo.toml') != ''
        run: |
          rustup component add clippy rustfmt
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings

      # Go fmt/vet if go.mod exists.
      - name: Go fmt + vet
        if: hashFiles('go.mod') != ''
        run: |
          go fmt ./...
          go vet ./...

  unit-and-integration-tests:
    name: Unit and Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - uses: actions/checkout@v4

      # Node tests
      - uses: actions/setup-node@v4
        if: hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != ''
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install Node deps (npm)
        if: hashFiles('package-lock.json') != ''
        run: npm ci
      - name: Install Node deps (pnpm)
        if: hashFiles('pnpm-lock.yaml') != ''
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: pnpm install
        if: hashFiles('pnpm-lock.yaml') != ''
        run: pnpm install --frozen-lockfile
      - name: Run Node tests
        if: hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != ''
        run: npm test --if-present || pnpm test --if-present

      # PHP tests
      - name: PHP tests
        if: hashFiles('composer.lock') != ''
        run: |
          composer install --no-interaction --prefer-dist
          ./vendor/bin/phpunit || true  # tighten to fail-hard when suite exists

      # Rust tests
      - name: Rust tests
        if: hashFiles('Cargo.toml') != ''
        run: cargo test --all

      # Go tests
      - name: Go tests
        if: hashFiles('go.mod') != ''
        run: go test ./...
