---
description: "CI/CD standards: gates, supply chain, and rollout safety."
alwaysApply: true
globs:
  - "**/*"
---

[CI/CD BASELINE]
- Pipeline stages: lint/format/type-check → unit tests + coverage → integration/smoke (DB/cache/API) → security scans (deps + secrets + static security) → build/package + SBOM/signing.
- Required gates: block on lint/type errors, test failures/flakiness, coverage drops in critical paths, and High/Critical vulnerabilities unless risk-accepted with expiry; fail if secrets scan hits.
- Supply chain: pin dependencies/locks; hermetic builds when possible; avoid `latest`; cache verified deps; publish SBOM as artifact.
- Deployment: prefer canary/blue-green; health/readiness checks mandatory; auto-rollback on triggers (p95 latency +20%/15m, error rate +0.5%/10m, critical security event).
- Environment/secrets: config via env/secret manager; least-privilege CI tokens; redact secrets from logs.

[ARCHITECTURE ENFORCEMENT]
- Required CI checks:
  - Static analysis (ESLint/Deptrac) must pass.
  - Architecture dependency checks must pass (layer dependencies, cross-context imports).
  - Public API module exports must be documented (JSDoc/TSDoc headers present).
  - No cross-context domain/infra imports (must use public API modules).
  - For TypeScript projects: path aliases must be used (no relative imports beyond 1 level). Other languages: enforce module/package boundaries using ecosystem-appropriate tools (Deptrac, package boundaries, etc.).
- Pre-commit hooks:
  - Run architecture checks before commit (static analysis, dependency validation).
  - Block commits with violations (layer dependencies, cross-context imports, path alias violations).
- PR requirements:
  - Architecture review for public API changes (new exports, breaking changes).
  - Documentation updates for new public APIs (JSDoc/TSDoc headers).
  - Verify no architecture violations introduced (use static analysis tools).

[VERIFICATION]
- Provide local pipeline command (e.g., `npm run lint && npm test`, `go test ./...`, `cargo fmt -- --check && cargo clippy && cargo test`) and reference CI workflow path.

[CI/CD AUTOMATION]

### GitHub Actions Workflows

**Architecture Check Workflow:** `.github/workflows/aegis-architecture-check.yml`
- Runs on: Pull requests and pushes to main branch
- Checks:
  - TypeScript: Path aliases, deep relative imports, cross-context imports
  - PHP: Deptrac layer dependency checks (if configured)
  - Java: Package boundary checks (requires ArchUnit setup)
  - C#: Architecture checks (requires ArchUnit.NET setup)
  - Public API module documentation (JSDoc/TSDoc headers)

**Existing Workflows:**
- `.github/workflows/aegis-ci.yml` — Lint, format, tests
- `.github/workflows/aegis-security.yml` — Dependency audits, security scans
- `.github/workflows/aegis-policy-check.yml` — Policy validation

### Pre-Commit Hooks

**Pre-Commit Configuration:** `.pre-commit-config.yaml`
- Install: `pip install pre-commit && pre-commit install`
- Run manually: `pre-commit run --all-files`
- Hooks:
  - ESLint with architecture rules (TypeScript)
  - Deep relative import checks
  - PHP: PHPCS + PHPStan
  - Rust: fmt + clippy
  - Go: fmt + vet
  - Python: Black + Ruff

**Standalone Script:** `scripts/pre-commit-architecture-check.sh`
- Can be used as git pre-commit hook: `ln -s ../../scripts/pre-commit-architecture-check.sh .git/hooks/pre-commit`
- Run manually: `./scripts/pre-commit-architecture-check.sh`
- Checks:
  - Deep relative imports (../../ or deeper)
  - Cross-context direct imports
  - Public API module documentation
  - ESLint with architecture rules

### Local Pipeline Commands

**TypeScript/JavaScript:**
```bash
# Run architecture checks
cd test/example-app
npm run lint  # Uses .eslintrc.json with architecture rules
npm run type-check
npm test

# Or use pre-commit
pre-commit run --all-files
```

**PHP:**
```bash
# Run Deptrac (if configured)
vendor/bin/deptrac analyse

# Or use pre-commit
pre-commit run --all-files
```

**All Languages:**
```bash
# Run pre-commit hooks
pre-commit run --all-files

# Or use standalone script
./scripts/pre-commit-architecture-check.sh
```
