#!/usr/bin/env php
<?php

declare(strict_types=1);

require_once __DIR__ . '/../vendor/autoload.php';

use AegisCodex\Bootstrap;

$bootstrap = new Bootstrap();

if ($argc < 2) {
    echo "Usage: php bin/console <command> [arguments...]\n";
    echo "\n";
    echo "Commands:\n";
    echo "  register-user <email> <password>  Register a new user\n";
    echo "  authenticate <email> <password>   Authenticate a user\n";
    echo "  place-order <userId> <amountCents> [currency]  Place an order\n";
    exit(1);
}

$command = $argv[1];

try {
    match ($command) {
        'register-user' => handleRegisterUser($bootstrap, $argv),
        'authenticate' => handleAuthenticate($bootstrap, $argv),
        'place-order' => handlePlaceOrder($bootstrap, $argv),
        default => throw new InvalidArgumentException("Unknown command: {$command}")
    };
} catch (Throwable $e) {
    echo "Error: {$e->getMessage()}\n";
    exit(1);
}

function handleRegisterUser(Bootstrap $bootstrap, array $argv): void
{
    if (!isset($argv[2]) || !isset($argv[3])) {
        throw new InvalidArgumentException("Usage: register-user <email> <password>");
    }

    $bootstrap->registerUserCli()->execute($argv[2], $argv[3]);
}

function handleAuthenticate(Bootstrap $bootstrap, array $argv): void
{
    if (!isset($argv[2]) || !isset($argv[3])) {
        throw new InvalidArgumentException("Usage: authenticate <email> <password>");
    }

    $bootstrap->authenticateUserCli()->execute($argv[2], $argv[3]);
}

function handlePlaceOrder(Bootstrap $bootstrap, array $argv): void
{
    if (!isset($argv[2]) || !isset($argv[3])) {
        throw new InvalidArgumentException("Usage: place-order <userId> <amountCents> [currency]");
    }

    $currency = $argv[4] ?? 'USD';
    $bootstrap->placeOrderCli()->execute($argv[2], (int) $argv[3], $currency);
}

